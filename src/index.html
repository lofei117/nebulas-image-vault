<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap 4, from LayoutIt!</title>
    <meta name="description" content="Source code generated using layoutit.com">
    <meta name="author" content="LayoutIt!">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <ul class="nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" href="#">Messages</a>
                    </li>
                    <li class="nav-item dropdown ml-md-auto">
                        <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown">Dropdown link</a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                            <a class="dropdown-item" href="#">Action</a> <a class="dropdown-item" href="#">Another action</a> <a class="dropdown-item" href="#">Something else here</a>
                            <div class="dropdown-divider">
                            </div> <a class="dropdown-item" href="#">Separated link</a>
                        </div>
                    </li>
                </ul>
                <div class="jumbotron">
                    <h2>
					Hello, world!
				</h2>
                    <p>
                        This is a template for a simple marketing or informational website. It includes a large callout called the hero unit and three supporting pieces of content. Use it as a starting point to create something more unique.
                    </p>
                    <p>
                        <a class="btn btn-primary btn-large" href="#">Learn more</a>
                    </p>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <form role="form">
                            <div class="form-group">
                                <label for="exampleInputEmail1">
                                    Email address
                                </label>
                                <input type="email" class="form-control" id="exampleInputEmail1" autocomplete="off" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAkCAYAAADo6zjiAAAAAXNSR0IArs4c6QAAAbNJREFUWAntV8FqwkAQnaymUkpChB7tKSfxWCie/Yb+gbdeCqGf0YsQ+hU95QNyDoWCF/HkqdeiIaEUqyZ1ArvodrOHxanQOiCzO28y781skKwFW3scPV1/febP69XqarNeNTB2KGs07U3Ttt/Ozp3bh/u7V7muheQf6ftLUWyYDB5yz1ijuPAub2QRDDunJsdGkAO55KYYjl0OUu1VXOzQZ64Tr+IiPXedGI79bQHdbheCIAD0dUY6gV6vB67rAvo6IxVgWVbFy71KBKkAFaEc2xPQarXA931ot9tyHphiPwpJgSbfe54Hw+EQHMfZ/msVEEURjMfjCjbFeG2dFxPo9/sVOSYzxmAwGIjnTDFRQLMQAjQ5pJAQkCQJ5HlekeERxHEsiE0xUUCzEO9AmqYQhiF0Oh2Yz+ewWCzEY6aYKKBZCAGYs1wuYTabKdNNMWWxnaA4gp3Yry5JBZRlWTXDvaozUgGTyQSyLAP0dbb3DtQlmcan0yngT2ekE9ARc+z4AvC7nauh9iouhpcGamJeX8XF8MaClwaeROWRA7nk+tUnyzGvZrKg0/40gdME/t8EvgG0/NOS6v9NHQAAAABJRU5ErkJggg==&quot;); background-repeat: no-repeat; background-attachment: scroll; background-size: 16px 18px; background-position: 98% 50%;">
                            </div>
                            <div class="form-group">
                                <label for="exampleInputPassword1">
                                    Password
                                </label>
                                <input type="password" class="form-control" id="exampleInputPassword1" autocomplete="off" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAkCAYAAADo6zjiAAAAAXNSR0IArs4c6QAAAbNJREFUWAntV8FqwkAQnaymUkpChB7tKSfxWCie/Yb+gbdeCqGf0YsQ+hU95QNyDoWCF/HkqdeiIaEUqyZ1ArvodrOHxanQOiCzO28y781skKwFW3scPV1/febP69XqarNeNTB2KGs07U3Ttt/Ozp3bh/u7V7muheQf6ftLUWyYDB5yz1ijuPAub2QRDDunJsdGkAO55KYYjl0OUu1VXOzQZ64Tr+IiPXedGI79bQHdbheCIAD0dUY6gV6vB67rAvo6IxVgWVbFy71KBKkAFaEc2xPQarXA931ot9tyHphiPwpJgSbfe54Hw+EQHMfZ/msVEEURjMfjCjbFeG2dFxPo9/sVOSYzxmAwGIjnTDFRQLMQAjQ5pJAQkCQJ5HlekeERxHEsiE0xUUCzEO9AmqYQhiF0Oh2Yz+ewWCzEY6aYKKBZCAGYs1wuYTabKdNNMWWxnaA4gp3Yry5JBZRlWTXDvaozUgGTyQSyLAP0dbb3DtQlmcan0yngT2ekE9ARc+z4AvC7nauh9iouhpcGamJeX8XF8MaClwaeROWRA7nk+tUnyzGvZrKg0/40gdME/t8EvgG0/NOS6v9NHQAAAABJRU5ErkJggg==&quot;); background-repeat: no-repeat; background-attachment: scroll; background-size: 16px 18px; background-position: 98% 50%;">
                            </div>
                            <div class="form-group">
                                <label for="exampleInputFile">
                                    Choose image.
                                </label>
                                <div id="image-preview">
                                    <label for="image" id="image-label">Choose File</label>
                                    <input type="file" name="image" id="image" accept="image/" />
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                Submit
                            </button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <h2>
						Heading
					</h2>
                        <p>
                            Donec id elit non mi porta gravida at eget metus. Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum nibh, ut fermentum massa justo sit amet risus. Etiam porta sem malesuada magna mollis euismod. Donec sed odio dui.
                        </p>
                        <p>
                            <a class="btn" href="#">View details »</a>
                        </p>
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>
                                #
                            </th>
                            <th>
                                Product
                            </th>
                            <th>
                                Payment Taken
                            </th>
                            <th>
                                Status
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                1
                            </td>
                            <td>
                                TB - Monthly
                            </td>
                            <td>
                                01/04/2012
                            </td>
                            <td>
                                Default
                            </td>
                        </tr>
                        <tr class="table-active">
                            <td>
                                1
                            </td>
                            <td>
                                TB - Monthly
                            </td>
                            <td>
                                01/04/2012
                            </td>
                            <td>
                                Approved
                            </td>
                        </tr>
                        <tr class="table-success">
                            <td>
                                2
                            </td>
                            <td>
                                TB - Monthly
                            </td>
                            <td>
                                02/04/2012
                            </td>
                            <td>
                                Declined
                            </td>
                        </tr>
                        <tr class="table-warning">
                            <td>
                                3
                            </td>
                            <td>
                                TB - Monthly
                            </td>
                            <td>
                                03/04/2012
                            </td>
                            <td>
                                Pending
                            </td>
                        </tr>
                        <tr class="table-danger">
                            <td>
                                4
                            </td>
                            <td>
                                TB - Monthly
                            </td>
                            <td>
                                04/04/2012
                            </td>
                            <td>
                                Call in to confirm
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/jquery.uploadPreview.min.js"></script>
    <script src="js/nebPay.js"></script>
    <script src="js/nebulas.js"></script>
    <script src="js/exif.min.js"></script>
    <script src="js/components/core-min.js"></script>
    <script src="js/rollups/sha256.js"></script>
    <script>
    "use strict";


    class Image {
        constructor() {}
        parse(jsonObject) {
            this.imageHash = jsonObject.imageHash;
            this.imageWidth = jsonObject.imageWidth;
            this.imageHeight = jsonObject.imageHeight;
            this.imageExif = jsonObject.imageExif;
            this.imageData = jsonObject.imageData;
        }

        getHash() {
            return this.imageHash;
        }
        getWidth() {
            return this.imageWidth;
        }
        getHeight() {
            return this.imageHeight;
        }
        getExif() {
            return this.imageExif;
        }
        getData() {
            return this.imageData;
        }
    }

    class Author {
        constructor() {}
        parse(jsonObject) {
            this.name = jsonObject.name;
            this.email = jsonObject.email;
        }
        getName() {
            return this.name;
        }
        getEmail() {
            return this.email;
        }
    }

    // $("#search_value").attr("disabled",true)
    // $("#search").attr("disabled",true)
    // //to check if the extension is installed
    // //if the extension is installed, var "webExtensionWallet" will be injected in to web page
    // if(typeof(webExtensionWallet) === "undefined"){
    //     //alert ("Extension wallet is not installed, please install it first.")
    //     $("#noExtension").removeClass("hide")
    // }else{
    //     $("#search_value").attr("disabled",false)
    //     $("#search").attr("disabled",false)
    // }

    var dappAddress = "n1pCoTERUeasQ9mFc9xfk6qUzBn1es9hbsD";

    //here we use neb.js to call the "get" function to search from the Dictionary
    var nebulas = require("nebulas"),
        Account = nebulas.Account,
        neb = new nebulas.Neb();
    // neb.setRequest(new nebulas.HttpRequest("https://testnet.nebulas.io"));
    neb.setRequest(new nebulas.HttpRequest("https://localhost:8685/"));



    var NebPay = require("nebpay"); //https://github.com/nebulasio/nebPay
    var nebPay = new NebPay();
    var serialNumber;

    var intervalQuery

    function funcIntervalQuery() {
        nebPay.queryPayInfo(serialNumber) //search transaction result from server (result upload to server by app)
            .then(function(resp) {
                console.log("tx result: " + resp) //resp is a JSON string
                var respObject = JSON.parse(resp)
                if (respObject.code === 0) {
                    alert(`set ${$("#search_value").val()} succeed!`)
                    clearInterval(intervalQuery)
                }
            })
            .catch(function(err) {
                console.log(err);
            });
    }

    function cbPush(resp) {
        console.log("response of push: " + JSON.stringify(resp))
    }

    var image = new Image();
    var author = new Author();

    $('#btn_upload').click(function() {

        author.name = $('#author_name').val();
        author.email = $('#author_email').val();

        var to = dappAddress;
        var value = "0";
        var callFunction = "save"
        var data = { "image": image, "author": author };
        var dataString = JSON.stringify(data);
        dataString = dataString.replace(/"/g, "\\\"");
        var callArgs = "[\"" + dataString + "\"]"

        console.log(callArgs)

        serialNumber = nebPay.call(to, value, callFunction, callArgs, { //使用nebpay的call接口去调用合约,
            listener: cbPush //设置listener, 处理交易返回信息
        });

        intervalQuery = setInterval(function() {
            funcIntervalQuery();
        }, 5000);
    });

    $(document).ready(function() {
        $.uploadPreview({
            input_field: "#image",
            preview_box: "#image-preview",
            label_field: "#image-label"
        });

        var oFile = new FileReader();
        var passFileType = /^(?:image\/bmp|image\/gif|image\/jpeg|image\/png)$/i;
        var demoLog = $('#demo-log');
        var fileLabel = $('#demo-preview');
        $('#image').on('change', function(e) {
            if (!e.target || !e.target.files.length || !e.target.files[0]) { return };

            var _file = e.target.files[0];

            if (!passFileType.test(_file.type)) { return };

            oFile.readAsDataURL(_file);
            // oFile.readAsArrayBuffer(_file);

            oFile.onloadend = function(evt) {
                if (evt.target.readyState == FileReader.DONE) { // DONE == 2

                    image.imageHash = CryptoJS.SHA256(evt.target.result);
                    image.imageData = evt.target.result;

                    EXIF.getData(_file, function() {
                        var _dataJson = JSON.stringify(EXIF.getAllTags(this));

                        var exif = EXIF.getAllTags(this);
                        image.imageWidth = exif.ImageWidth;
                        image.imageHeight = exif.ImageHeight;
                        image.imageExif = exif;


                        demoLog.html(_dataJson);

                        var _rotate = 0;
                        var _orientation = EXIF.getTag(this, 'Orientation');

                        if (_orientation == 3) {
                            _rotate = 180;
                        } else if (_orientation == 6) {
                            _rotate = 90;
                        } else if (_orientation == 8) {
                            _rotate = 270;
                        };
                        fileLabel.addClass('rotate-' + _rotate);
                    });

                    $('#btn_upload').prop('disabled', false);

                }
            };

        });

    });


    // var port = chrome.runtime.connect({ name: "contentscript" });
    // port.postMessage({ src: "contentScript", dst: "background" });

    // port.onMessage.addListener(function(msg) {
    //     console.log("port.onMessage: " + JSON.stringify(msg));

    //     window.postMessage({ //forward msg from background to webpage
    //         "data": msg
    //     }, "*");

    // });
    </script>
</body>

</html>