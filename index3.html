<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width,initial-scale=0.5, maximum-scale=0.5, minimum-scale=0.5, user-scalable=no">
    <meta name="x5-fullscreen" content="true">
    <meta name="full-screen" content="yes">
    <title>Super Dictionary</title>
    <link rel="stylesheet" href="lib/bootstrap-4.0.0-dist/css/bootstrap.min.css">
    <style>
    #image-preview {
        width: 400px;
        height: 400px;
        position: relative;
        overflow: hidden;
        background-color: #ffffff;
        color: #ecf0f1;
    }

    #image-preview input {
        line-height: 200px;
        font-size: 200px;
        position: absolute;
        opacity: 0;
        z-index: 10;
    }

    #image-preview label {
        position: absolute;
        z-index: 5;
        opacity: 0.8;
        cursor: pointer;
        background-color: #bdc3c7;
        width: 200px;
        height: 50px;
        font-size: 20px;
        line-height: 50px;
        text-transform: uppercase;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        margin: auto;
        text-align: center;
    }
    </style>
</head>

<body>
    <div class="contenner">
        <div class="noExtension hide" id="noExtension">
            NOTE: Please install <a target="_blank" href="https://github.com/ChengOrangeJu/WebExtensionWallet">WebExtensionWallet</a> to use SUPER DICTIONARY
        </div>
        <div class="example">
            <div id="image-preview">
                <label for="image" id="image-label">Choose File</label>
                <input type="file" name="image" id="image" accept="image/" />
            </div>
            <div class="info">
                <h3>查看 EXIF 信息</h3>
                <p>通过左侧选择文件，获取该图片的 EXIF 信息。</p>
                <h4>EXIF.getAllTags()</h4>
                <div id="demo-log" class="log"></div>
                <h4>Author name</h4>
                <input type="text" name="author_name" id='author_name' />
                <h4>Author email</h4>
                <input type="text" name="author_email" id='author_email' />
            </div>
            <div class="action">
                <button id=btn_upload disabled="true">upload</button>
            </div>
        </div>
    </div>
    </div>
    <script src="lib/jquery-3.3.1.min.js"></script>
    <script src="lib/jquery.uploadPreview.min.js"></script>
    <script src="lib/nebPay.js"></script>
    <script src="lib/bootstrap-4.0.0-dist/js/bootstrap.min.js"></script>
    <script src="lib/nebulas.js"></script>
    <script src="lib/exif.min.js"></script>
    <script src="lib/components/core-min.js"></script>
    <script src="lib/rollups/sha256.js"></script>
    <script>
    "use strict";


    class Image {
        constructor() {}
        parse(jsonObject) {
            this.imageHash = jsonObject.imageHash;
            this.imageWidth = jsonObject.imageWidth;
            this.imageHeight = jsonObject.imageHeight;
            this.imageExif = jsonObject.imageExif;
            this.imageData = jsonObject.imageData;
        }

        getHash() {
            return this.imageHash;
        }
        getWidth() {
            return this.imageWidth;
        }
        getHeight() {
            return this.imageHeight;
        }
        getExif() {
            return this.imageExif;
        }
        getData() {
            return this.imageData;
        }
    }

    class Author {
        constructor() {}
        parse(jsonObject) {
            this.name = jsonObject.name;
            this.email = jsonObject.email;
        }
        getName() {
            return this.name;
        }
        getEmail() {
            return this.email;
        }
    }

    // $("#search_value").attr("disabled",true)
    // $("#search").attr("disabled",true)
    // //to check if the extension is installed
    // //if the extension is installed, var "webExtensionWallet" will be injected in to web page
    // if(typeof(webExtensionWallet) === "undefined"){
    //     //alert ("Extension wallet is not installed, please install it first.")
    //     $("#noExtension").removeClass("hide")
    // }else{
    //     $("#search_value").attr("disabled",false)
    //     $("#search").attr("disabled",false)
    // }

    var dappAddress = "n1pCoTERUeasQ9mFc9xfk6qUzBn1es9hbsD";

    //here we use neb.js to call the "get" function to search from the Dictionary
    var nebulas = require("nebulas"),
        Account = nebulas.Account,
        neb = new nebulas.Neb();
    // neb.setRequest(new nebulas.HttpRequest("https://testnet.nebulas.io"));
    neb.setRequest(new nebulas.HttpRequest("https://localhost:8685/"));



    var NebPay = require("nebpay"); //https://github.com/nebulasio/nebPay
    var nebPay = new NebPay();
    var serialNumber;

    var intervalQuery

    function funcIntervalQuery() {
        nebPay.queryPayInfo(serialNumber) //search transaction result from server (result upload to server by app)
            .then(function(resp) {
                console.log("tx result: " + resp) //resp is a JSON string
                var respObject = JSON.parse(resp)
                if (respObject.code === 0) {
                    alert(`set ${$("#search_value").val()} succeed!`)
                    clearInterval(intervalQuery)
                }
            })
            .catch(function(err) {
                console.log(err);
            });
    }

    function cbPush(resp) {
        console.log("response of push: " + JSON.stringify(resp))
    }

    var image = new Image();
    var author = new Author();

    $('#btn_upload').click(function() {

        author.name = $('#author_name').val();
        author.email = $('#author_email').val();

        var to = dappAddress;
        var value = "0";
        var callFunction = "save"
        var data = { "image": image, "author": author };
        var dataString = JSON.stringify(data);
        dataString = dataString.replace(/"/g, "\\\"");
        var callArgs = "[\"" + dataString + "\"]"

        console.log(callArgs)

        serialNumber = nebPay.call(to, value, callFunction, callArgs, { //使用nebpay的call接口去调用合约,
            listener: cbPush //设置listener, 处理交易返回信息
        });

        intervalQuery = setInterval(function() {
            funcIntervalQuery();
        }, 5000);
    });

    $(document).ready(function() {
        $.uploadPreview({
            input_field: "#image",
            preview_box: "#image-preview",
            label_field: "#image-label"
        });

        var oFile = new FileReader();
        var passFileType = /^(?:image\/bmp|image\/gif|image\/jpeg|image\/png)$/i;
        var demoLog = $('#demo-log');
        var fileLabel = $('#demo-preview');
        $('#image').on('change', function(e) {
            if (!e.target || !e.target.files.length || !e.target.files[0]) { return };

            var _file = e.target.files[0];

            if (!passFileType.test(_file.type)) { return };

            oFile.readAsDataURL(_file);
            // oFile.readAsArrayBuffer(_file);

            oFile.onloadend = function(evt) {
                if (evt.target.readyState == FileReader.DONE) { // DONE == 2

                    var wordArray = CryptoJS.lib.WordArray.create(e.target.result);
                    image.imageHash = CryptoJS.SHA256(wordArray);
                    image.imageData = evt.target.result;

                    EXIF.getData(_file, function() {
                        var _dataJson = JSON.stringify(EXIF.getAllTags(this));

                        var exif = EXIF.getAllTags(this);
                        image.imageWidth = exif.ImageWidth;
                        image.imageHeight = exif.ImageHeight;
                        image.imageExif = exif;


                        demoLog.html(_dataJson);

                        var _rotate = 0;
                        var _orientation = EXIF.getTag(this, 'Orientation');

                        if (_orientation == 3) {
                            _rotate = 180;
                        } else if (_orientation == 6) {
                            _rotate = 90;
                        } else if (_orientation == 8) {
                            _rotate = 270;
                        };
                        fileLabel.addClass('rotate-' + _rotate);
                    });

                    $('#btn_upload').prop('disabled', false);

                }
            };

        });

    });


    // var port = chrome.runtime.connect({ name: "contentscript" });
    // port.postMessage({ src: "contentScript", dst: "background" });

    // port.onMessage.addListener(function(msg) {
    //     console.log("port.onMessage: " + JSON.stringify(msg));

    //     window.postMessage({ //forward msg from background to webpage
    //         "data": msg
    //     }, "*");

    // });
    </script>
</body>

</html>